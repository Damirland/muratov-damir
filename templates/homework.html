<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è 8–ê</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    <style>
        /* –¢–µ –∂–µ —Å—Ç–∏–ª–∏, —á—Ç–æ –∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π */
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --primary-blue: #007bff; --text-main: #2c3e50; --text-muted: #7f8c8d; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); }
        h1 { text-align: center; margin-bottom: 30px; color: var(--primary-blue); }
        .timetable { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; max-width: 1600px; margin: 0 auto; width: 100%; }
        .day-card { background: var(--card-bg); border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); padding: 15px; flex: 1 1 200px; max-width: none; }
        .day-title { font-size: 20px; font-weight: bold; color: var(--primary-blue); border-bottom: 2px solid #eef2f7; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        .lesson { padding: 12px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid #ccc; background: #f8f9fa; }
        .lesson-main { display: flex; justify-content: space-between; align-items: center; gap: 10px; font-weight: 600;}
        .day-card.today { border: 2px solid var(--primary-blue); box-shadow: 0 0 20px rgba(0, 123, 255, 0.15); position: relative; }
        
        /* –ù–û–í–´–ô –°–¢–ò–õ–¨: –ñ–µ–ª—Ç–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –¥–æ–º–∞—à–∫–∏ */
        .homework-box {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f5feff;
            border-left: 4px solid rgba(68, 180, 245, 0);
            border-radius: 6px;
            font-size: 14px;
            color: #5c4b00;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .loader-container { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 0; color: var(--primary-blue); font-weight: 600; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0, 123, 255, 0.2); border-top: 4px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .creator-badge { position: absolute; top: 20px; right: 20px; font-size: 14px; font-weight: 600; color: var(--text-muted); text-decoration: none; background: var(--card-bg); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; }
        .creator-badge:hover { color: var(--primary-blue); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2); transform: translateY(-2px); }
        @media (max-width: 600px) { .creator-badge { position: relative; display: block; top: 0; right: 0; width: max-content; margin: 0 auto 15px auto; text-align: center; } h1 { margin-top: 5px; } }
        /* –ö–Ω–æ–ø–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
        .refresh-btn {
            background: var(--card-bg);
            border: 2px solid #eef2f7;
            color: var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-left: 10px;
        }

        .refresh-btn:hover {
            border-color: var(--primary-blue);
            color: white;
            background: var(--primary-blue);
            transform: translateY(-2px);
        }

        .refresh-btn:active {
            transform: scale(0.9);
        }

        .refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –°–í–û–†–ê–ß–ò–í–ê–ù–ò–Ø –ö–ê–†–¢–û–ß–ï–ö --- */
        .day-title {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –≤—ã–¥–µ–ª—è–ª—Å—è –ø—Ä–∏ —Å–ª—É—á–∞–π–Ω–æ–º –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ */
        }
        
        .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }

        .day-content {
            display: block;
        }

        /* –ï—Å–ª–∏ —É –∫–∞—Ä—Ç–æ—á–∫–∏ –µ—Å—Ç—å –∫–ª–∞—Å—Å collapsed, –ø—Ä—è—á–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫—Ä—É—Ç–∏–º —Å—Ç—Ä–µ–ª–æ—á–∫—É */
        .day-card.collapsed .day-content {
            display: none;
        }

        .day-card.collapsed .toggle-icon {
            transform: rotate(90deg); /* –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É */
        }
    </style>
</head>
<body>
    <a href="https://t.me/wisposhka" target="_blank" class="creator-badge">@wisposhka</a>

    <h1>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è 8–ê</h1>
    
    <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 5px; margin-bottom: 20px;">
        <a href="/" style="text-decoration: none; padding: 10px; color: #007bff;">–î–Ω–µ–≤–Ω–∏–∫</a> | 
        <a href="/main" style="text-decoration: none; padding: 10px; color: #007bff;">–û—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a> |
        <span style="padding: 10px; color: #7f8c8d; font-weight: bold;">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</span>
        
        <button class="refresh-btn" onclick="forceRefresh()" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </button>
    </div>

    <div class="timetable" id="timetableContainer">
        <div class="loader-container">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...</div>
        </div>
    </div>

    <script>
        async function fetchHomework() {
            try {
                const [scheduleRes, hwRes] = await Promise.all([
                    fetch('/api/timetable'),
                    fetch('/api/homework')
                ]);
                
                const lessons = await scheduleRes.json();
                const hwData = await hwRes.json();

                const fullWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
                const hwMap = {};
                const normalize = (str) => str.trim().toLowerCase();

                function subjectExistsOnDay(subject, day) {
                    const normSub = normalize(subject);
                    return lessons.some(l => l.day === day && normalize(l.subject) === normSub);
                }

                hwData.forEach(hw => {
                    if (hw.task === "-") return;

                    let startIndex = fullWeek.indexOf(hw.day);
                    let targetDay = hw.day;

                    if (startIndex !== -1) {
                        // –ò—â–µ–º –¢–û–õ–¨–ö–û –≤–ø–µ—Ä–µ–¥ –¥–æ –ø—è—Ç–Ω–∏—Ü—ã
                        for (let i = startIndex; i < fullWeek.length; i++) {
                            if (subjectExistsOnDay(hw.subject, fullWeek[i])) {
                                targetDay = fullWeek[i];
                                break;
                            }
                        }
                    }

                    const key = `${targetDay}_${normalize(hw.subject)}`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –æ–±—ä–µ–∫—Ç (—Ç–µ–∫—Å—Ç + —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ)
                    if (hwMap[key]) {
                        hwMap[key].task += `<br><br><span style="color:#ffffff; font-size:12px; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px;">+ –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:</span><br>` + hw.task;
                        if (hw.photo_url) hwMap[key].photo = hw.photo_url;
                    } else {
                        hwMap[key] = { task: hw.task, photo: hw.photo_url };
                    }
                });

                renderHomework(lessons, hwMap);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞:", err);
                document.getElementById('timetableContainer').innerHTML = '<div class="loader-container" style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
            }
        }

        function renderHomework(lessons, hwMap) {
            const container = document.getElementById('timetableContainer');
            container.innerHTML = '';
            
            const daysData = {};
            lessons.forEach(lesson => {
                if (!daysData[lesson.day]) daysData[lesson.day] = [];
                daysData[lesson.day].push(lesson);
            });

            const fullWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'];
            const todayName = new Intl.DateTimeFormat('ru-RU', { weekday: 'long' }).format(new Date());
            const capitalizedToday = todayName.charAt(0).toUpperCase() + todayName.slice(1);
            const normalize = (str) => str.trim().toLowerCase();

            fullWeek.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                const isToday = day === capitalizedToday;
                const isMobile = window.innerWidth <= 600;

                if (isToday) dayCard.classList.add('today');
                
                // --- –†–ê–ó–î–ï–õ–ï–ù–ò–ï –õ–û–ì–ò–ö–ò: –¢–ï–õ–ï–§–û–ù vs –ü–ö ---
                if (isMobile) {
                    dayCard.classList.add('collapsed'); // –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    dayCard.innerHTML = `
                        <div class="day-title" onclick="this.parentElement.classList.toggle('collapsed')">
                            <span>${day}</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                    `;
                } else {
                    // –ù–∞ –ü–ö –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–º, —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –∫–ª–∏–∫–∞—Ç—å
                    dayCard.innerHTML = `
                        <div class="day-title" style="cursor: default;">
                            <span>${day}</span>
                        </div>
                    `;
                }
                
                const dayContent = document.createElement('div');
                dayContent.className = 'day-content';
                
                const dayLessons = daysData[day];
                let hasHomeworkForDay = false;

                if (dayLessons && dayLessons.length > 0) {
                    dayLessons.sort((a, b) => a.lesson_num - b.lesson_num);
                    dayLessons.forEach(lesson => {
                        const key = `${day}_${normalize(lesson.subject)}`;
                        const hwObj = hwMap[key];
                        
                        if (hwObj) {
                            hasHomeworkForDay = true;
                            const lessonDiv = document.createElement('div');
                            lessonDiv.className = 'lesson';
                            
                            const colors = {
                                '–ê–ª–≥–µ–±—Ä–∞': '#4c6ef5', '–ì–µ–æ–º–µ—Ç—Ä–∏—è': '#4c6ef5', '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞': '#4c6ef5', 
                                '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞': '#4c6ef5', '–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ': '#4c6ef5',
                                '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫': '#ff922b', '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞': '#ff922b', '–ü—Ä–∞–∫—Ç–∏–∫—É–º –ø–æ —Ä—É—Å—Å–∫–æ–º—É —è–∑—ã–∫—É': '#ff922b', 
                                '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å': '#ff922b', '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫': '#e03131', 
                                '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ / –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': '#c2255b', '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': '#845ef7', 
                                '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': '#7048e8', '–§–∏–∑–∏–∫–∞': '#15aabf', '–•–∏–º–∏—è': '#0ca678', 
                                '–ë–∏–æ–ª–æ–≥–∏—è': '#40c057', '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è': '#fab005', '–ò—Å—Ç–æ—Ä–∏—è': '#fa5252', 
                                '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ': '#be4bdb', '–°–µ–º—å–µ–≤–µ–¥–µ–Ω–∏–µ': '#f06595', '–û–ë–ó–†': '#5c940d',
                                '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞': '#51cf66', '–ú—É–∑—ã–∫–∞': '#fcc419', '–¢—Ä—É–¥': '#a34e24', '–ö–ª–∞—Å—Å–Ω—ã–π —á–∞—Å': '#20c997'
                            };

                            const subjectColor = colors[lesson.subject] || '#ccc';
                            lessonDiv.style.borderLeftColor = subjectColor;

                            let photoHtml = "";
                            if (hwObj.photo) {
                                photoHtml = `
                                    <div style="margin-top: 10px; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 8px;">
                                        <a href="${hwObj.photo}" target="_blank">
                                            <img src="${hwObj.photo}" alt="–§–æ—Ç–æ –∑–∞–¥–∞–Ω–∏—è" style="max-width: 100%; max-height: 250px; border-radius: 6px; display: block; margin: 0 auto; object-fit: contain;">
                                        </a>
                                        <div style="text-align: center; font-size: 11px; margin-top: 5px; color: #ffffff; opacity: 0.8;">–ù–∞–∂–º–∏ –Ω–∞ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å</div>
                                    </div>
                                `;
                            }

                            lessonDiv.innerHTML = `
                                <div class="lesson-main">
                                    <span style="color: var(--primary-blue)">${lesson.subject}</span>
                                </div>
                                <div class="homework-box">
                                    <strong>–î–ó:</strong> ${hwObj.task.replace(/\n/g, '<br>')}
                                    ${photoHtml}
                                </div>
                            `;
                            dayContent.appendChild(lessonDiv);
                        }
                    });
                } 
                
                if (!hasHomeworkForDay) {
                    dayContent.innerHTML += `<div style="text-align:center; color:#aaa; font-style:italic; padding: 20px 0;">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç ü•≥</div>`;
                }

                dayCard.appendChild(dayContent);
                container.appendChild(dayCard);
            });
        }

        // –ö–Ω–æ–ø–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        async function forceRefresh() {
            const btn = document.getElementById('refreshBtn');
            if(btn) btn.classList.add('spinning');
            const container = document.getElementById('timetableContainer');
            container.innerHTML = `<div class="loader-container"><div class="spinner"></div><div>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div></div>`;
            await fetchHomework();
            if(btn) setTimeout(() => { btn.classList.remove('spinning'); }, 500);
        }

        window.onload = fetchHomework;
    </script>
</body>
</html>